---
title: "CHOPOFF GUIDE"
author: "Kornel Labun & Haakon Tjeldnes"
date: "`r BiocStyle::doc_date()`"
package: "`r pkg_ver('ORFik')`"
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{CHOPOFF GUIDE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

Welcome to crisprCHOPOFF, the R wrapper for CHOPOFF.

## Overview
This vignette shows 2 examples:

1. Simple Run of Ca9 guides
2. A short example in crisprVerse syntax, comparing bowtie to CHOPOFF 
 for finding a justified candidate guide 
3. A Full example in crisprVerse syntax, comparing bowtie to CHOPOFF 
 for finding a justified candidate guide, with some analysis 
 
## Simple run

Here we will 
```{r simple}
library(crisprCHOPOFF)

name <- "CAS9"
genome <- system.file("extdata/sample_genome", "semirandom.fa", package = "crisprCHOPOFF")
## Note: a fasta index ".fai" file must exist in directory of genome.
# You can make it with:
#if (!file.exists(paste0(genome, ".fai"))) {
#Rsamtools::indexFa(genome)
#}
out_dir_index <- file.path(tempdir(), "CHOPOFF_sample_genome")
build_index(name, genome, out_dir_index, distance = 2)
#'
# Now search some guides
guides <- system.file("extdata/sample_genome", "guides.txt", package = "crisprCHOPOFF")
# Quick preview in guides:
guide_candidates <- read.table(guides, col.names = "guides")
unique(nchar(unlist(guide_candidates))) # Unique lengths of guides
guide_hits <- search_index(guides, out_dir_index, distance = 2, validate = FALSE)
guide_hits_table <- read.table(guide_hits, sep = ",", header = TRUE)
# use data.table::fread for reading in large list
# Subset to 0 distance hits
dist0 <- guide_hits_table[guide_hits_table$distance == 0,]
head(dist0)
# Which chromosomes is a specific guide found on with 0 distance hits?
unique(dist0[dist0$guide == "TCCGGCCTGGTTATCGAAGG",]$chromosome) # 2 chromosomes
```

## Short crisprVerse example

First we replicate the default bowtie run from crisprVerse vignette,
then we show how to run CHOPOFF to get similar results.

```{r crisprVerse}
# Load required libraries
{
library(crisprDesign)
library(BSgenome.Hsapiens.UCSC.hg38)
library(crisprBase)
library(Rbowtie)
library(crisprCHOPOFF)
}
# Run crisprVerse example (find guide candidates in human gene: IQSEC3)
{
  data(SpCas9, package="crisprBase")
  SpCas9
  gr <- queryTxObject(txObject=grListExample,
                      featureType="cds",
                      queryColumn="gene_symbol",
                      queryValue="IQSEC3")[1] # exon 1
  guideSet <- findSpacers(gr,
                          bsgenome=BSgenome.Hsapiens.UCSC.hg38,
                          crisprNuclease=SpCas9)
  
  set.seed(10)
  guideSet <- guideSet[sample(seq_along((guideSet)), 20)] # Sample a subset
  
  guideSet <- addSequenceFeatures(guideSet) # Branching point for CHOPOFF/bowtie
}

# The offtarget detection using Bowtie:
{
  # The offtarget detection using bowtie
  fasta <- system.file(package="crisprDesign", "fasta/chr12.fa")
  outdir <- tempdir()
  Rbowtie::bowtie_build(fasta,
                        outdir=outdir,
                        force=TRUE,
                        prefix="chr12")
  bowtie_index <- file.path(outdir, "chr12")
  
  guideSetBowTie <- addSpacerAlignments(guideSet,
                                  txObject=grListExample,
                                  aligner_index=bowtie_index,
                                  bsgenome=BSgenome.Hsapiens.UCSC.hg38,
                                  n_mismatches=2)
  # Off target score
  guideSetBowTie <- addOffTargetScores(guideSetBowTie)
  # On target score
  guideSetBowTie <- addOnTargetScores(guideSetBowTie, methods="crisprater")
}
# The offtarget detection using CHOPOFF:
{
  # Input parameters
name <- "human_chr12_CHOPOFF_CAS9"
out_dir_index <- file.path(tempdir(), name)
no_fasta_index <- !file.exists(paste0(fasta, ".fai"))
if (no_fasta_index) Rsamtools::indexFa(fasta)

build_index(name, fasta, out_dir_index, distance = 2, validate = FALSE)
guideSetCHOPOFF <- addSpacerAlignmentsCHOPOFF(guideSetTemplate, out_dir_index, 
                                              distance = 2, validate = FALSE)
# On target score (This is valid)
guideSetCHOPOFF <- addOnTargetScores(guideSetCHOPOFF, methods="crisprater")
}

# Results to compare
guideSetBowTie
guideSetCHOPOFF

```
## Full crisprVerse example

First we replicate the default bowtie run from crisprVerse vignette,
then we show how to run CHOPOFF to get similar results.
This example is better to run through, since it contains some additional
analysis for understanding.

```{r crisprVerse}
# Load required libraries
{
library(crisprDesign)
library(BSgenome.Hsapiens.UCSC.hg38)
library(crisprBase)
library(Rbowtie)
library(crisprCHOPOFF)
}
# Run crisprVerse example (find guide candidates in human gene: IQSEC3)
{
  data(SpCas9, package="crisprBase")
  SpCas9
  gr <- queryTxObject(txObject=grListExample,
                      featureType="cds",
                      queryColumn="gene_symbol",
                      queryValue="IQSEC3")
  gr <- gr[1] # exon 1
  bsgenome <- BSgenome.Hsapiens.UCSC.hg38
  guideSet <- findSpacers(gr,
                          bsgenome=bsgenome,
                          crisprNuclease=SpCas9)
  guideSet
  
  set.seed(10)
  guideSet <- guideSet[sample(seq_along((guideSet)), 20)] # Sample a subset
  spacers(guideSet)
  protospacers(guideSet)
  pams(guideSet)
  head(pamSites(guideSet))
  head(cutSites(guideSet))
  
  guideSet <- addSequenceFeatures(guideSet)
  guideSetTemplate <- guideSet # Branching point for CHOPOFF
  head(guideSet)
}

# The offtarget detection using Bowtie:
{
  # The offtarget detection using bowtie
  fasta <- system.file(package="crisprDesign", "fasta/chr12.fa")
  outdir <- tempdir()
  Rbowtie::bowtie_build(fasta,
                        outdir=outdir,
                        force=TRUE,
                        prefix="chr12")
  bowtie_index <- file.path(outdir, "chr12")
  
  guideSet <- addSpacerAlignments(guideSet,
                                  txObject=grListExample,
                                  aligner_index=bowtie_index,
                                  bsgenome=bsgenome,
                                  n_mismatches=2)
  guideSetBowTie <- guideSet # To compare with CHOPOFF output
  guideSet
  # Off target score
  guideSet <- addOffTargetScores(guideSet)
  guideSet
  table(guideSet$score_cfd)
  
  # On target score
  guideSet <- addOnTargetScores(guideSet, methods="crisprater")
  head(guideSet)
  table(guideSet$score_crisprater)
  
  # Final filter:
  guideSetFilter <- guideSet[guideSet$percentGC>=20]
  guideSetFilter <- guideSetFilter[guideSetFilter$percentGC<=80]
  guideSetFilter <- guideSetFilter[!guideSetFilter$polyT]
  selected_bowtie <- guideSetFilter[guideSetFilter$score_crisprater > 0.8] 
  selected_bowtie # Our final candidate
}
# The offtarget detection using CHOPOFF

name <- "human_chr12_CHOPOFF_CAS9"
out_dir_index <- file.path(tempdir(), name)
if (!file.exists(paste0(fasta, ".fai"))) Rsamtools::indexFa(fasta)
build_index(name, fasta, out_dir_index, distance = 2, validate = FALSE)

guideSetCHOPOFF <- addSpacerAlignmentsCHOPOFF(guideSetTemplate, out_dir_index, distance = 2)

# Off target score (This do not really make sense, because CHOPOFF supports bulges)
# guideSetCHOPOFF <- addOffTargetScores(guideSetCHOPOFF)
# guideSetCHOPOFF
# table(guideSetCHOPOFF$score_cfd)

# On target score (This is valid)
guideSetCHOPOFF <- addOnTargetScores(guideSetCHOPOFF, methods="crisprater")
head(guideSetCHOPOFF)
table(guideSetCHOPOFF$score_crisprater)

# Final filter:
guideSetCHOPOFFFilter <- guideSetCHOPOFF[guideSetCHOPOFF$percentGC>=20]
guideSetCHOPOFFFilter <- guideSetCHOPOFFFilter[guideSetCHOPOFFFilter$percentGC<=80]
guideSetCHOPOFFFilter <- guideSetCHOPOFFFilter[!guideSetCHOPOFFFilter$polyT]
selected_CHOPOFF <-  guideSetCHOPOFFFilter[guideSetCHOPOFFFilter$score_crisprater > 0.8] 
selected_CHOPOFF # Our final candidate

# Now lets compare
identical(ranges(selected_CHOPOFF), ranges(selected_bowtie)) # We pick same site

# All guides analysis
guideSetBowTie
guideSetCHOPOFF

identical(as.character(guideSetBowTie$protospacer), as.character(guideSetCHOPOFF$protospacer))

identical(ranges(guideSetBowTie), ranges(guideSetCHOPOFF))
identical(guideSetBowTie$n0, guideSetCHOPOFF$n0)
# CHOPOFF supports searching for bulges, so results do not match.

table(mcols(guideSetBowTie)[,c("n0")])
table(mcols(guideSetCHOPOFF)[,c("n0")])
table(mcols(guideSetBowTie)[,c("n2")])
table(mcols(guideSetCHOPOFF)[,c("n2")]) # <- 1 (1 distance hit), 2 (2 distance hits)


```

